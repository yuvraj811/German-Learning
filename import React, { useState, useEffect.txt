import React, { useState, useEffect } from 'react';
import { 
  Languages, 
  BookA, 
  SpellCheck, 
  ArrowRightLeft, 
  Volume2, 
  Copy, 
  Check, 
  Moon, 
  Sun,
  Loader2,
  Sparkles,
  Bot,
  AlertCircle
} from 'lucide-react';

// --- CONFIGURATION ---
const USE_SIMULATION_MODE = false; 

// --- MOCK DATA FOR SIMULATION ---
const MOCK_TRANSLATIONS = {
  'hello': 'hallo',
  'world': 'welt',
  'good morning': 'guten morgen',
  'thank you': 'danke schön',
  'i love coding': 'ich liebe das programmieren',
  'hallo': 'hello',
  'welt': 'world',
  'katze': 'cat'
};

const MOCK_DICTIONARY = {
  'apple': {
    word: 'apple',
    phonetic: '/ˈæp.əl/',
    meanings: [
      { partOfSpeech: 'noun', definition: 'A round fruit with red or green skin and a whitish inside.', example: 'I ate an apple for lunch.' }
    ]
  },
  'laufen': {
    word: 'laufen',
    phonetic: '/ˈlaʊ̯fn̩/',
    meanings: [
      { partOfSpeech: 'verb', definition: 'To run or walk quickly.', example: 'Wir laufen nach Hause.' }
    ]
  }
};

// Updated mock data structure for the new AI format
const MOCK_GRAMMAR = {
  analyzedOriginal: "Ich habe {{GRAMMAR:der}} {{SPELLING:Apfel}} gegessen.",
  corrected: "Ich habe den Apfel gegessen.",
  explanations: [
    "Grammar: 'der' is the wrong article. 'Apfel' is masculine and implies the accusative case here, so it should be 'den'.",
    "Spelling: Nouns in German must always be capitalized (Apfel)."
  ]
};

export default function App() {
  const [activeTab, setActiveTab] = useState('translator'); // translator, dictionary, grammar
  const [darkMode, setDarkMode] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  
  // Input States
  const [inputText, setInputText] = useState('');
  const [result, setResult] = useState(null);
  
  // Translator specific
  const [transLang, setTransLang] = useState({ from: 'EN', to: 'DE' });

  // Effects
  useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [darkMode]);

  // --- GEMINI API HELPER ---
  const callGemini = async (prompt, systemPrompt) => {
    const apiKey = ""; // Automatically injected by the environment
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    
    // We request JSON specifically in the payload config for better structured output
    const payload = {
      contents: [{ parts: [{ text: prompt }] }],
      systemInstruction: { parts: [{ text: systemPrompt }] },
      generationConfig: { responseMimeType: "application/json" }
    };

    let attempt = 0;
    const delays = [1000, 2000, 4000, 8000, 16000];

    while (attempt <= 5) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          if (response.status === 429 || response.status >= 500) {
             // Retryable errors
             throw new Error(`Retryable error: ${response.status}`);
          }
          throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      } catch (e) {
        if (attempt === 5) throw e;
        await new Promise(r => setTimeout(r, delays[attempt]));
        attempt++;
      }
    }
  };

  // --- LOGIC HANDLERS ---

  const handleTranslate = async () => {
    if (!inputText.trim()) return;
    setIsLoading(true);
    setResult(null);

    try {
      if (USE_SIMULATION_MODE) {
        await new Promise(resolve => setTimeout(resolve, 800));
        const key = inputText.toLowerCase().trim();
        const translation = MOCK_TRANSLATIONS[key] || `(Simulated Translation) ${transLang.to === 'DE' ? 'Das ist ' : 'This is '}${inputText}`;
        setResult({ text: translation });
      } else {
        const systemPrompt = `You are a professional bilingual translator fluent in English and German. 
        Your task is to translate the user's input from ${transLang.from === 'EN' ? 'English to German' : 'German to English'}.
        Ensure the tone is natural and grammatically correct.
        Return ONLY the translated text. Do not include quotes, preambles, or explanations unless the word has multiple distinct meanings that require context.`;

        const translatedText = await callGemini(inputText, systemPrompt);
        
        if (!translatedText) throw new Error("No translation returned.");

        setResult({ text: translatedText.trim() });
      }
    } catch (error) {
      console.error(error);
      setResult({ error: "Translation failed. Please try again." });
    } finally {
      setIsLoading(false);
    }
  };

  const handleDictionary = async () => {
    if (!inputText.trim()) return;
    setIsLoading(true);
    setResult(null);

    try {
      if (USE_SIMULATION_MODE) {
        await new Promise(resolve => setTimeout(resolve, 800));
        const key = inputText.toLowerCase().trim();
        const data = MOCK_DICTIONARY[key] || {
          word: inputText,
          phonetic: '/???/',
          meanings: [{ partOfSpeech: 'unknown', definition: 'Definition not found in simulation mode. Try "apple" or "laufen".', example: '-' }]
        };
        setResult({ type: 'dictionary', data: data });
      } else {
        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${inputText}`);
        if (!response.ok) throw new Error('Word not found');
        const data = await response.json();
        
        const entry = data[0];
        const simpleData = {
          word: entry.word,
          phonetic: entry.phonetic,
          meanings: entry.meanings.map(m => ({
            partOfSpeech: m.partOfSpeech,
            definition: m.definitions[0].definition,
            example: m.definitions[0].example
          }))
        };
        setResult({ type: 'dictionary', data: simpleData });
      }
    } catch (error) {
      setResult({ error: "Word not found or API error." });
    } finally {
      setIsLoading(false);
    }
  };

  const handleGrammarCheck = async () => {
    if (!inputText.trim()) return;
    setIsLoading(true);
    setResult(null);

    try {
      if (USE_SIMULATION_MODE) {
        await new Promise(resolve => setTimeout(resolve, 1200));
        setResult({ type: 'grammar', data: MOCK_GRAMMAR });
      } else {
        // --- GEMINI AI GRAMMAR CHECK ---
        const systemPrompt = `You are an expert German Grammar Teacher.
        Analyze the user's German text for spelling and grammar errors.
        
        Return a valid JSON object with exactly these three fields:
        1. "corrected": The fully corrected German sentence.
        2. "analyzedOriginal": The user's original text, but wrap any errors in special tags:
           - Use {{SPELLING:word}} for spelling mistakes.
           - Use {{GRAMMAR:word}} for grammar/syntax mistakes.
           - Example: "Ich {{GRAMMAR:habe}} {{SPELLING:Apfel}}."
        3. "explanations": An array of strings. Each string must be a clear explanation of an error IN ENGLISH.
        
        If there are no errors, "analyzedOriginal" should be the same as the input, and "explanations" should be empty.`;

        const responseText = await callGemini(inputText, systemPrompt);
        const data = JSON.parse(responseText);

        setResult({ 
          type: 'grammar', 
          data: {
            analyzedOriginal: data.analyzedOriginal,
            corrected: data.corrected,
            explanations: data.explanations || []
          }
        });
      }
    } catch (error) {
      console.error(error);
      setResult({ error: "Grammar check failed. Please try again." });
    } finally {
      setIsLoading(false);
    }
  };

  const handleSwapLanguages = () => {
    setTransLang(prev => ({ from: prev.to, to: prev.from }));
    setInputText(result?.text || ''); 
    setResult(null);
  };

  const handleCopy = (text) => {
    navigator.clipboard.writeText(text);
  };

  const handleSpeak = (text, lang) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang === 'DE' ? 'de-DE' : 'en-US';
    window.speechSynthesis.speak(utterance);
  };

  // --- HELPER TO RENDER HIGHLIGHTED TEXT ---
  // Parses "This is {{SPELLING:wrong}} and {{GRAMMAR:bad}}."
  const renderHighlightedText = (text) => {
    if (!text) return null;
    
    // Regex to capture {{TYPE:content}}
    // Group 1: Type (SPELLING/GRAMMAR), Group 2: Content
    const regex = /\{\{(SPELLING|GRAMMAR):(.+?)\}\}/g;
    
    const parts = [];
    let lastIndex = 0;
    let match;

    while ((match = regex.exec(text)) !== null) {
      // Push text before the match
      if (match.index > lastIndex) {
        parts.push(text.substring(lastIndex, match.index));
      }

      const type = match[1]; // SPELLING or GRAMMAR
      const content = match[2]; // The word itself

      // Push the highlighted element
      parts.push(
        <span 
          key={match.index} 
          className={`
            border-b-2 font-medium px-0.5
            ${type === 'SPELLING' ? 'border-red-500 text-red-700 dark:text-red-300 bg-red-50 dark:bg-red-900/20' : ''}
            ${type === 'GRAMMAR' ? 'border-blue-500 text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/20' : ''}
          `}
          title={type === 'SPELLING' ? 'Spelling Error' : 'Grammar Error'}
        >
          {content}
        </span>
      );

      lastIndex = regex.lastIndex;
    }

    // Push remaining text
    if (lastIndex < text.length) {
      parts.push(text.substring(lastIndex));
    }

    return parts;
  };

  // --- UI COMPONENTS ---

  const TabButton = ({ id, label, icon: Icon }) => (
    <button
      onClick={() => { setActiveTab(id); setResult(null); setInputText(''); }}
      className={`flex items-center gap-2 px-4 py-3 text-sm font-medium transition-colors border-b-2 ${
        activeTab === id
          ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400 dark:border-indigo-400'
          : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200'
      }`}
    >
      <Icon size={18} />
      {label}
    </button>
  );

  return (
    <div className={`min-h-screen transition-colors duration-300 ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* HEADER */}
      <header className="sticky top-0 z-10 backdrop-blur-md bg-white/70 dark:bg-slate-900/70 border-b border-gray-200 dark:border-slate-800">
        <div className="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="bg-indigo-600 p-2 rounded-lg text-white">
              <Sparkles size={20} />
            </div>
            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600 dark:from-indigo-400 dark:to-violet-400">
              EngDeutsch
            </h1>
          </div>
          <button 
            onClick={() => setDarkMode(!darkMode)}
            className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-800 transition-colors"
          >
            {darkMode ? <Sun size={20} /> : <Moon size={20} />}
          </button>
        </div>
      </header>

      {/* MAIN CONTAINER */}
      <main className="max-w-3xl mx-auto px-4 py-8">
        
        {/* TABS */}
        <div className="flex border-b border-gray-200 dark:border-slate-800 mb-6 overflow-x-auto">
          <TabButton id="translator" label="Translator" icon={Languages} />
          <TabButton id="dictionary" label="Word Meaning" icon={BookA} />
          <TabButton id="grammar" label="Grammar Check" icon={SpellCheck} />
        </div>

        {/* INPUT AREA */}
        <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden">
          
          {/* Toolbar */}
          <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-slate-700 bg-gray-50/50 dark:bg-slate-800/50">
            {activeTab === 'translator' ? (
              <div className="flex items-center gap-3">
                <span className="font-semibold text-sm text-gray-600 dark:text-gray-300 w-8">{transLang.from}</span>
                <button onClick={handleSwapLanguages} className="p-1.5 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-full transition-colors">
                  <ArrowRightLeft size={16} className="text-gray-500" />
                </button>
                <span className="font-semibold text-sm text-indigo-600 dark:text-indigo-400 w-8">{transLang.to}</span>
              </div>
            ) : (
              <span className="text-sm font-medium text-gray-500">
                {activeTab === 'dictionary' ? 'Enter a word (English or German)' : 'Enter German text to check'}
              </span>
            )}
            
            {inputText && (
              <button onClick={() => setInputText('')} className="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                Clear
              </button>
            )}
          </div>

          {/* Textarea */}
          <textarea
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
            placeholder={
              activeTab === 'translator' ? 'Type text to translate...' :
              activeTab === 'dictionary' ? 'Type a single word...' :
              'Type German text (e.g. "Ich habe der Apfel gegessen")'
            }
            className="w-full h-40 p-4 bg-transparent resize-none outline-none text-lg text-gray-800 dark:text-gray-100 placeholder-gray-400"
          />

          {/* Action Footer */}
          <div className="px-4 py-3 flex justify-end">
            <button
              onClick={activeTab === 'translator' ? handleTranslate : activeTab === 'dictionary' ? handleDictionary : handleGrammarCheck}
              disabled={isLoading || !inputText}
              className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 shadow-md shadow-indigo-200 dark:shadow-none"
            >
              {isLoading ? <Loader2 size={18} className="animate-spin" /> : (activeTab === 'dictionary' ? <BookA size={18} /> : <Bot size={18} />)}
              {activeTab === 'translator' ? 'Translate with AI' : activeTab === 'dictionary' ? 'Get Meaning' : 'Check with AI'}
            </button>
          </div>
        </div>

        {/* RESULT AREA */}
        {result && (
          <div className="mt-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {result.error ? (
              <div className="p-4 rounded-xl bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-300 border border-red-100 dark:border-red-900/50 flex items-center gap-2">
                <AlertCircle size={20} />
                {result.error}
              </div>
            ) : (
              <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-gray-100 dark:border-slate-700 overflow-hidden">
                
                {/* Translator Result */}
                {activeTab === 'translator' && (
                  <div className="p-6">
                    <div className="flex justify-between items-start mb-2">
                      <h3 className="text-sm font-medium text-gray-400 uppercase tracking-wider flex items-center gap-2">
                        <Bot size={14} /> AI Translation
                      </h3>
                      <div className="flex gap-2">
                        <button onClick={() => handleSpeak(result.text, transLang.to)} className="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-gray-500">
                          <Volume2 size={18} />
                        </button>
                        <button onClick={() => handleCopy(result.text)} className="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-gray-500">
                          <Copy size={18} />
                        </button>
                      </div>
                    </div>
                    <p className="text-2xl font-light text-gray-800 dark:text-white leading-relaxed">
                      {result.text}
                    </p>
                  </div>
                )}

                {/* Dictionary Result */}
                {activeTab === 'dictionary' && result.data && (
                  <div className="p-6">
                    <div className="flex items-baseline gap-4 mb-4">
                      <h2 className="text-3xl font-bold text-indigo-600 dark:text-indigo-400">{result.data.word}</h2>
                      <span className="text-gray-500 font-mono">{result.data.phonetic}</span>
                    </div>
                    
                    <div className="space-y-6">
                      {result.data.meanings.map((meaning, idx) => (
                        <div key={idx} className="group">
                          <div className="flex items-center gap-3 mb-2">
                            <span className="px-2 py-1 text-xs font-bold uppercase bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 rounded">
                              {meaning.partOfSpeech}
                            </span>
                          </div>
                          <p className="text-gray-800 dark:text-gray-200 mb-2">{meaning.definition}</p>
                          {meaning.example && (
                            <p className="text-gray-500 italic border-l-2 border-gray-200 dark:border-slate-600 pl-3">
                              "{meaning.example}"
                            </p>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Grammar Result (Updated with AI, Color Coding, and English Analysis) */}
                {activeTab === 'grammar' && result.data && (
                  <div className="divide-y divide-gray-100 dark:divide-slate-700">
                    
                    {/* Line-by-Line Comparison Header */}
                    <div className="p-4 bg-gray-50 dark:bg-slate-900/50 flex justify-between items-center">
                       <h3 className="text-sm font-bold text-gray-500 uppercase flex items-center gap-2">
                         <Bot size={16} /> AI Analysis
                       </h3>
                       <div className="flex gap-4 text-xs font-medium">
                         <span className="flex items-center gap-1.5 text-red-600 dark:text-red-400">
                           <span className="w-2 h-2 rounded-full bg-red-500"></span> Spelling
                         </span>
                         <span className="flex items-center gap-1.5 text-blue-600 dark:text-blue-400">
                           <span className="w-2 h-2 rounded-full bg-blue-500"></span> Grammar
                         </span>
                       </div>
                    </div>

                    {/* Comparison Area */}
                    <div className="p-6 grid gap-6">
                      
                      {/* Original (Marked) */}
                      <div>
                        <div className="text-xs font-semibold text-gray-400 mb-2 uppercase">Your Sentence</div>
                        <p className="text-xl text-gray-800 dark:text-gray-200 leading-relaxed font-light">
                          {renderHighlightedText(result.data.analyzedOriginal)}
                        </p>
                      </div>

                      {/* Corrected */}
                      <div>
                        <div className="text-xs font-semibold text-green-600 dark:text-green-500 mb-2 uppercase flex items-center gap-1">
                          <Check size={12} /> Corrected
                        </div>
                        <p className="text-xl text-green-800 dark:text-green-100 leading-relaxed bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-100 dark:border-green-900/30">
                          {result.data.corrected}
                        </p>
                      </div>
                    
                    </div>
                    
                    {/* English Analysis List */}
                    <div className="p-6 bg-white dark:bg-slate-800">
                      <h3 className="text-sm font-bold text-gray-400 uppercase mb-4">Feedback</h3>
                      {(!result.data.explanations || result.data.explanations.length === 0) ? (
                        <p className="text-gray-600 dark:text-gray-300 flex items-center gap-2">
                          <Check size={18} className="text-green-500" /> 
                          No errors found. Excellent German!
                        </p>
                      ) : (
                        <ul className="space-y-3">
                          {result.data.explanations.map((explanation, idx) => (
                            <li key={idx} className="flex gap-3 text-gray-700 dark:text-gray-300">
                              <span className="mt-1.5 w-1.5 h-1.5 rounded-full bg-indigo-500 shrink-0"></span>
                              <span>{explanation}</span>
                            </li>
                          ))}
                        </ul>
                      )}
                    </div>
                  </div>
                )}

              </div>
            )}
          </div>
        )}

      </main>
      
      {/* FOOTER */}
      <footer className="text-center py-8 text-gray-400 text-sm">
        <p>Built with React & Tailwind • Powered by Gemini AI</p>
      </footer>

    </div>
  );
}